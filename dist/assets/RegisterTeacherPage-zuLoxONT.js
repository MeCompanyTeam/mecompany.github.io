import{u as V,r as t,j as e,L as f,s as i}from"./index-Do9N5Bdr.js";import{P as Y}from"./PasswordStrengthMeter-BDx7gZ8o.js";import{P as q,i as M}from"./index-DBV7NSSN.js";/* empty css              */import{C as U}from"./circle-check-big-BRjEOzgi.js";import"./index-KxUSDxB7.js";const J=()=>{const C=V(),[p,j]=t.useState(1),[l,n]=t.useState(""),[d,o]=t.useState(!1),[u,k]=t.useState(""),[g,N]=t.useState(""),[r,P]=t.useState(null),[h,w]=t.useState(""),[v,S]=t.useState(""),[m,E]=t.useState(""),[x,I]=t.useState(!1),[y,X]=t.useState(!1),[b,A]=t.useState(!1),[R,T]=t.useState("PL");t.useEffect(()=>{fetch("https://ipapi.co/json/").then(s=>{if(!s.ok)throw new Error(`Network response was not ok: ${s.statusText}`);return s.json()}).then(s=>{s&&s.country_code&&T(s.country_code)}).catch(s=>{console.error("Could not fetch geolocation data:",s)})},[]);const z=async s=>{s.preventDefault(),o(!0),n("");const{data:a,error:c}=await i.rpc("verify_teacher_invite",{p_code:g,p_email:u});c?n(c.message):a&&a.length>0?(P(a[0]),j(2)):n("Invalid email or code. Please check your invitation and try again."),o(!1)},F=async s=>{if(s.preventDefault(),h!==v){n("Passwords do not match.");return}if(!x){n("You must accept the Terms & Privacy policy to register.");return}if(m&&!M(m)){n("Please enter a valid phone number.");return}o(!0),n("");const{data:{user:a}={},error:c}=await i.auth.signUp({email:u,password:h,options:{data:{first_name:r==null?void 0:r.first_name,last_name:r==null?void 0:r.last_name,role:"teacher",phone:m}}});if(c){n(c.message),o(!1);return}if(a){const{error:_}=await i.rpc("claim_teacher_code",{p_code:g,p_user_id:a.id});if(_){n(`Your account was created, but we failed to link you to the institution. Please contact support. Error: ${_.message}`),o(!1);return}try{await Promise.all([i.functions.invoke("record-consent",{body:{user_id:a.id,consent_type:"terms_and_privacy",granted:x}}),i.functions.invoke("record-consent",{body:{user_id:a.id,consent_type:"marketing_emails",granted:y}}),i.functions.invoke("record-consent",{body:{user_id:a.id,consent_type:"personalization",granted:b}})])}catch(L){console.error("Consent recording error",L)}alert("Registration successful! Please check your email to confirm your account."),C("/login/teacher")}o(!1)};return e.jsx("div",{className:"rt-auth-container",children:e.jsxs("div",{className:"rt-auth-box",children:[p===1&&e.jsxs("form",{className:"rt-auth-form",onSubmit:z,children:[e.jsx("h1",{children:"Teacher Registration"}),e.jsx("p",{children:"Please enter your email and the invitation code provided by your institution."}),l&&e.jsx("p",{className:"rt-error-message",children:l}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",type:"email",value:u,onChange:s=>k(s.target.value),placeholder:"your.email@example.com",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"invite-code",children:"Invitation Code"}),e.jsx("input",{id:"invite-code",type:"text",value:g,onChange:s=>N(s.target.value),placeholder:"XXX-XXX-XXX",required:!0})]}),e.jsx("button",{type:"submit",className:"rt-btn",disabled:d,children:d?"Verifying...":"Verify Code"}),e.jsx("div",{className:"rt-auth-footer",children:e.jsxs("p",{children:["Already have an account? ",e.jsx(f,{to:"/login/teacher",children:"Log In"})]})})]}),p===2&&r&&e.jsxs("div",{className:"rt-verified",children:[e.jsx("div",{className:"rt-verified-icon","aria-hidden":!0,children:e.jsx(U,{size:36,color:"var(--rt-success)"})}),e.jsx("h1",{children:"Invitation Verified!"}),e.jsxs("p",{children:["Welcome, ",e.jsxs("strong",{children:[r.first_name," ",r.last_name]}),"."]}),e.jsxs("p",{children:["You have been invited to join ",e.jsx("strong",{children:r.institution_name}),"."]}),e.jsx("button",{className:"rt-btn",onClick:()=>j(3),children:"Confirm & Continue"})]}),p===3&&e.jsxs("form",{className:"rt-auth-form",onSubmit:F,children:[e.jsx("h1",{children:"Set Your Password"}),e.jsxs("p",{children:["You are registering as ",e.jsxs("strong",{children:[r==null?void 0:r.first_name," ",r==null?void 0:r.last_name]})," (",u,")."]}),l&&e.jsx("p",{className:"rt-error-message",children:l}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"password",children:"Password"}),e.jsx("input",{id:"password",type:"password",value:h,onChange:s=>w(s.target.value),required:!0})]}),e.jsx(Y,{password:h}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"confirm-password",children:"Confirm Password"}),e.jsx("input",{id:"confirm-password",type:"password",value:v,onChange:s=>S(s.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"phone",children:"Phone Number (Optional)"}),e.jsx("div",{className:"rt-phone-input",children:e.jsx(q,{id:"phone",international:!0,countryCallingCodeEditable:!1,defaultCountry:R,value:m,onChange:E})})]}),e.jsx("hr",{className:"rt-hr"}),e.jsxs("div",{className:"form-group rt-consent-group",children:[e.jsxs("label",{className:"consent-label",children:[e.jsx("input",{type:"checkbox",checked:x,onChange:s=>I(s.target.checked)}),e.jsxs("span",{children:["I agree to the ",e.jsx(f,{to:"/terms",target:"_blank",rel:"noopener noreferrer",children:"Terms of Service"})," and ",e.jsx(f,{to:"/privacy",target:"_blank",rel:"noopener noreferrer",children:"Privacy Policy"}),". *"]})]}),e.jsxs("label",{className:"consent-label",children:[e.jsx("input",{type:"checkbox",checked:y,onChange:s=>X(s.target.checked)}),e.jsx("span",{children:"I agree to receive marketing emails."})]}),e.jsxs("label",{className:"consent-label",children:[e.jsx("input",{type:"checkbox",checked:b,onChange:s=>A(s.target.checked)}),e.jsx("span",{children:"I agree to experience personalization."})]})]}),e.jsx("button",{type:"submit",className:"rt-btn",disabled:d,children:d?"Registering...":"Complete Registration"})]})]})})};export{J as default};
