import{c as b,a as q,b as E,r as y,j as e,s as d}from"./index-Do9N5Bdr.js";import{u as f}from"./useQuery-Bmia-r3M.js";import{U as I}from"./users-BCv83-ox.js";import{C as A}from"./circle-plus-C4i9EsG5.js";import{C as L,a as k}from"./copy-Bprm7ZNx.js";/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],G=b("triangle-alert",z),S=async s=>{const{data:n,error:i}=await d.from("profiles").select(`
      id,
      institution_id,
      student_limit:student_limits ( max_students ),
      student_count:teacher_students!teacher_id ( count )
    `).eq("id",s).single();if(i)throw i;return n},K=async s=>{const{data:n,error:i}=await d.from("teacher_invites").select("*").eq("teacher_id",s).eq("is_active",!0).order("created_at",{ascending:!1});if(i)throw i;return n},D=()=>{var j,p;const{user:s}=q(),n=E(),[i,h]=y.useState(!1),[v,m]=y.useState(""),{data:a,isLoading:l,error:c}=f({queryKey:["teacher_invite_data",s.id],queryFn:()=>S(s.id),enabled:!!s}),{data:u,isLoading:w}=f({queryKey:["teacher_active_invites",s.id],queryFn:()=>K(s.id),enabled:!!s});a&&console.log("Raw Teacher Data from Supabase:",a),c&&console.error("Error fetching teacher data:",c);const C=async()=>{h(!0),m("");try{const{error:t}=await d.rpc("teacher_generate_student_invite");if(t)throw t;n.invalidateQueries({queryKey:["teacher_active_invites"]}),n.invalidateQueries({queryKey:["teacher_invite_data"]})}catch(t){m(t.message)}finally{h(!1)}},N=async t=>{if(window.confirm("Are you sure you want to deactivate this invite code?"))try{const{error:o}=await d.rpc("teacher_deactivate_student_invite",{p_invite_id:t});if(o)throw o;n.invalidateQueries({queryKey:["teacher_active_invites"]})}catch(o){alert(`Error: ${o.message}`)}},x=((j=a==null?void 0:a.student_count[0])==null?void 0:j.count)??0,r=a==null?void 0:a.student_limit,_=Array.isArray(r)?((p=r[0])==null?void 0:p.max_students)??0:(r==null?void 0:r.max_students)??0,g=x<_;return e.jsxs("div",{className:"manage-invites-page",children:[e.jsxs("div",{className:"invites-header",children:[e.jsx("h1",{children:"Manage Student Invites"}),l?e.jsx("p",{children:"Loading teacher data..."}):c?e.jsxs("p",{className:"error-message",children:["Error loading data: ",c.message]}):e.jsxs("div",{className:"student-limit-indicator",children:[e.jsx(I,{size:20}),e.jsxs("span",{children:["Students: ",e.jsxs("strong",{children:[x," / ",_]})]})]})]}),v&&e.jsx("p",{className:"error-message",children:v}),e.jsxs("div",{className:"invites-action-box",children:[e.jsx("h2",{children:"Generate New Invite Code"}),e.jsx("p",{children:"Click the button to generate a new, single-use invite code for a student to join your class."}),!g&&!l&&e.jsxs("div",{className:"limit-warning",children:[e.jsx(G,{size:16}),"You have reached your student limit. You cannot generate new invites."]}),e.jsxs("button",{className:"btn",onClick:C,disabled:i||!g||l,children:[e.jsx(A,{size:20}),i?"Generating...":"Generate Code"]})]}),e.jsxs("div",{className:"invites-list-section",children:[e.jsx("h2",{children:"Active Invite Codes"}),w&&e.jsx("p",{children:"Loading invites..."}),u&&u.length>0?e.jsx("div",{className:"invites-list",children:u.map(t=>e.jsxs("div",{className:"invite-card",children:[e.jsx("div",{className:"invite-code",children:e.jsx("span",{children:t.code})}),e.jsxs("div",{className:"invite-details",children:[e.jsxs("span",{children:["Created: ",new Date(t.created_at).toLocaleDateString()]}),e.jsxs("span",{children:["Uses: ",t.used_count," / ",t.max_uses]})]}),e.jsxs("div",{className:"invite-actions",children:[e.jsx("button",{className:"btn-secondary icon-btn",title:"Copy Code",onClick:()=>navigator.clipboard.writeText(t.code),children:e.jsx(L,{size:18})}),e.jsx("button",{className:"btn-danger icon-btn",title:"Deactivate Code",onClick:()=>N(t.id),children:e.jsx(k,{size:18})})]})]},t.id))}):e.jsx("p",{children:"You have no active invite codes."})]})]})};export{D as default};
