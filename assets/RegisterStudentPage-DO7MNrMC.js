import{u as M,r as t,j as e,L as j,s as i}from"./index-Do9N5Bdr.js";import{P as U}from"./PasswordStrengthMeter-BDx7gZ8o.js";import{P as $,i as B}from"./index-DBV7NSSN.js";/* empty css              */import{C as O}from"./circle-check-big-BRjEOzgi.js";import"./index-KxUSDxB7.js";const Z=()=>{const k=M(),[x,v]=t.useState(1),[c,r]=t.useState(""),[l,n]=t.useState(!1),[d,P]=t.useState(""),[u,w]=t.useState(""),[g,S]=t.useState(""),[h,E]=t.useState(null),[b,I]=t.useState(""),[m,A]=t.useState(""),[y,F]=t.useState(""),[p,R]=t.useState(""),[f,X]=t.useState(!1),[N,L]=t.useState(!1),[C,q]=t.useState(!1),[z,D]=t.useState("PL");t.useEffect(()=>{fetch("https://ipapi.co/json/").then(s=>{if(!s.ok)throw new Error(`Network response was not ok: ${s.statusText}`);return s.json()}).then(s=>{s&&s.country_code&&D(s.country_code)}).catch(s=>{console.error("Could not fetch geolocation data:",s)})},[]);const T=async s=>{s.preventDefault(),n(!0),r("");const{data:a,error:o}=await i.rpc("verify_student_invite",{p_code:g});o?r(o.message):a&&a.length>0?(E(a[0]),v(2)):r("Invalid or expired invitation code."),n(!1)},V=async s=>{if(s.preventDefault(),r(""),m!==y){r("Passwords do not match.");return}if(!f){r("You must accept the Terms & Privacy policy to register.");return}if(p&&!B(p)){r("Please enter a valid phone number.");return}n(!0);const{data:{user:a}={},error:o}=await i.auth.signUp({email:b,password:m,options:{data:{first_name:d,last_name:u,role:"student",phone:p}}});if(o){r(o.message),n(!1);return}if(a){const{error:_}=await i.rpc("claim_student_invite",{p_code:g,p_student_id:a.id});if(_){r(`Account created, but failed to link to teacher. Contact support. Error: ${_.message}`),n(!1);return}try{await Promise.all([i.functions.invoke("record-consent",{body:{user_id:a.id,consent_type:"terms_and_privacy",granted:f}}),i.functions.invoke("record-consent",{body:{user_id:a.id,consent_type:"marketing_emails",granted:N}}),i.functions.invoke("record-consent",{body:{user_id:a.id,consent_type:"personalization",granted:C}})])}catch(Y){console.error("Consent RPC error",Y)}alert("Registration successful! Please check your email to confirm your account."),k("/login/student")}n(!1)};return e.jsx("div",{className:"rs-auth-container",children:e.jsxs("div",{className:"rs-auth-box",children:[x===1&&e.jsxs("form",{className:"rs-auth-form",onSubmit:T,children:[e.jsx("h1",{children:"Student Registration"}),e.jsx("p",{children:"Please enter your details and the invitation code provided by your teacher."}),c&&e.jsx("p",{className:"rs-error-message",children:c}),e.jsxs("div",{className:"rs-form-grid",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"firstName",children:"First Name"}),e.jsx("input",{id:"firstName",type:"text",value:d,onChange:s=>P(s.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"lastName",children:"Last Name"}),e.jsx("input",{id:"lastName",type:"text",value:u,onChange:s=>w(s.target.value),required:!0})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"invite-code",children:"Invitation Code"}),e.jsx("input",{id:"invite-code",type:"text",value:g,onChange:s=>S(s.target.value),placeholder:"XXX-XXX-XXX",required:!0})]}),e.jsx("button",{type:"submit",className:"rs-btn",disabled:l,children:l?"Verifying...":"Next"}),e.jsx("div",{className:"rs-auth-form-footer",children:e.jsxs("p",{children:["Already have an account? ",e.jsx(j,{to:"/login/student",children:"Log In"})]})})]}),x===2&&h&&e.jsxs("div",{className:"rs-verified",children:[e.jsx("div",{className:"rs-verified-icon","aria-hidden":!0,children:e.jsx(O,{size:36,color:"var(--rs-success)"})}),e.jsx("h1",{children:"Invitation Verified!"}),e.jsxs("p",{children:["Welcome, ",e.jsxs("strong",{children:[d," ",u]}),"."]}),e.jsxs("p",{children:["You were invited by ",e.jsxs("strong",{children:[h.teacher_first_name," ",h.teacher_last_name]})," to join ",e.jsx("strong",{children:h.institution_name}),"."]}),e.jsx("button",{className:"rs-btn",onClick:()=>v(3),children:"Confirm & Continue"})]}),x===3&&e.jsxs("form",{className:"rs-auth-form",onSubmit:V,children:[e.jsx("h1",{children:"Complete Your Registration"}),e.jsxs("p",{children:["You are registering as ",e.jsxs("strong",{children:[d," ",u]}),"."]}),c&&e.jsx("p",{className:"rs-error-message",children:c}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",type:"email",value:b,onChange:s=>I(s.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"password",children:"Password"}),e.jsx("input",{id:"password",type:"password",value:m,onChange:s=>A(s.target.value),required:!0})]}),e.jsx(U,{password:m}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"confirm-password",children:"Confirm Password"}),e.jsx("input",{id:"confirm-password",type:"password",value:y,onChange:s=>F(s.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"phone",children:"Phone Number (Optional)"}),e.jsx("div",{className:"rs-phone-input",children:e.jsx($,{id:"phone",international:!0,countryCallingCodeEditable:!1,defaultCountry:z,value:p,onChange:R})})]}),e.jsx("hr",{className:"hr"}),e.jsxs("div",{className:"form-group rs-consent-group",children:[e.jsxs("label",{className:"consent-label",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:s=>X(s.target.checked)}),e.jsxs("span",{children:["I agree to the ",e.jsx(j,{to:"/terms",target:"_blank",rel:"noopener noreferrer",children:"Terms of Service"})," and ",e.jsx(j,{to:"/privacy",target:"_blank",rel:"noopener noreferrer",children:"Privacy Policy"}),". *"]})]}),e.jsxs("label",{className:"consent-label",children:[e.jsx("input",{type:"checkbox",checked:N,onChange:s=>L(s.target.checked)}),e.jsx("span",{children:"I agree to receive marketing emails."})]}),e.jsxs("label",{className:"consent-label",children:[e.jsx("input",{type:"checkbox",checked:C,onChange:s=>q(s.target.checked)}),e.jsx("span",{children:"I agree to experience personalization."})]})]}),e.jsx("button",{type:"submit",className:"rs-btn",disabled:l,children:l?"Registering...":"Complete Registration"})]})]})})};export{Z as default};
